<header id="pageHeader"><h1>{{title}}</h1></header>
<main id="mainArticle">
<div id="inner-grid">
<top id="topMain">
	<h2>CODEC Settings</h2>
</top>
<left id="leftMain">
{{>din side="left"}}
</left>
<right id="rightMain">
{{>din side="right"}}
</right>
<common id="commonMain">
	<h3>Shared Controls</h3>
	<div class="control">Playback Common Mode Voltage {{>playswitch selectid='playbackcmsw'}}</div>
</common>
</div>
</main>
<nav id="mainNav"><!-- Add Navigation Here --></nav>
<footer id="pageFooter">
	<div>
	<span id="product">{{stats.hat.product}}</span> | 
	<span id="sensors"> </span>
	</div>
	<div>
	<span id="model">{{stats.model}}</span> |
	CPU Temp: <span id="cputemp">{{stats.cputemp.f}} &deg; F ({{stats.cputemp.c}} &deg; C)</span> &bull;
	Uptime: <span id="uptime">(Collecting)</span> &bull;
	Load AVG: <span id="loadavg">(Collecting)</span>
	</div>
</footer>
<script>
const socket = io.connect();
console.log(socket);

function sset(control) {
	let val = "";
	switch(parseInt(control)) {
		case 1: 
			val += document.getElementById("left-pcmvol").value;
			val += "," + document.getElementById("right-pcmvol").value;
			break;
		case 2:
			// this.left.setPowerTune(control.curvalues);
			break;
		case 3:
			// this.right.setPowerTune(control.curvalues);
			break;
		case 5:
			val += document.getElementById("left-lodigvol").value;
			val += "," + document.getElementById("right-lodigvol").value;
			break;
		case 7:
			// this.left.setDACSwitch(control.curleft);
			// this.right.setDACSwitch(control.curright);
			break;
		case 8:
			let psv = document.getElementById("playbackcmsw").value;
			switch(parseInt(psv)) {
				case 0:
					val = "Full Chip CM";
					break;
				case 1:
					val = "1.65V";
					break;
				default:
					console.log("Bad Value for playbackcmsw");
					break;
			}
			break;
		case 12:
			val += document.getElementById("left-adcvol").value;
			val += "," + document.getElementById("right-adcvol").value;
			break;
		case 28:
			// this.left.setOutputSwitch(control.curvalues);
			break;
		case 31:
			// this.right.setOutputSwitch(control.curvalues);
			break;
		case 32:
			// this.right.setDiscInResistor(control.curvalues);
			break;
		case 33:
			// this.right.setAFinResistor(control.curvalues);
			break;
		case 36:
			// this.right.setNegativeResistor(control.curvalues);
			break;
		case 39:
			// this.left.setDiscInResistor(control.curvalues);
			break;
		case 40:
			// this.left.setAFinResistor(control.curvalues);
			break;
		case 43:
			// this.left.setNegativeResistor(control.curvalues);
			break;
		default: 
			val = "Unknown";
			break;
	}
	
	let message ={control:control,value:val};
	socket.emit('sset',message,function(data){console.log(data)});
	console.log(message);
}

function DACset() {
	let message = {};
	let lv = document.getElementById('left-audiorx').value;
	let rv = document.getElementById('right-audiorx').value;
	console.log(lv + " " + rv);
	let leftdacswitch = "on";
	let leftdacplaysw = "on";
	let rightdacswitch = "on";
	let rightdacplaysw = "on";
	switch (lv) {
		case "off" :
			message = {control:40,value:'Off'};
			socket.emit('sset',message,function(data){console.log(data)});
			message = {control:39,value:'Off'};
			socket.emit('sset',message,function(data){console.log(data)});
			leftdacswitch = "off";
			leftdacplaysw = "off";
			break;
		case 'af' :
			message = {control:40,value:'10 kOhm'}; // 10KOhm
			socket.emit('sset',message,function(data){console.log(data)});
			message = {control:39,value:'Off'}; // off
			socket.emit('sset',message,function(data){console.log(data)});
			break;
		case 'disc' :
			message = {control:40,value:'Off'};
			socket.emit('sset',message,function(data){console.log(data)});
			message = {control:39,value:'10 kOhm'};
			socket.emit('sset',message,function(data){console.log(data)});
			break;
		default : 
			console.log('Left DAC Bad ' + lv);
			break;
	}	
	switch (rv) {
		case "off" :
			message = {control:33,value:'Off'}; 
			socket.emit('sset',message,function(data){console.log(data)});
			message = {control:32,value:'Off'};
			socket.emit('sset',message,function(data){console.log(data)});
			rightdacswitch = "off";
			rightdacplaysw = "off";
			break;
		case 'af' :
			message = {control:33,value:'10 kOhm'}; // 10KOhm
			socket.emit('sset',message,function(data){console.log(data)});
			message = {control:32,value:'Off'}; // off
			socket.emit('sset',message,function(data){console.log(data)});
			break;
		case 'disc' :
			message = {control:33,value:'Off'};
			socket.emit('sset',message,function(data){console.log(data)});
			message = {control:32,value:'10 kOhm'};
			socket.emit('sset',message,function(data){console.log(data)});
			break;
		default : 
			console.log('Right DAC Bad ' + lv);
			break;
	}	

	// set left and right neg resistors
	message = {control:36,value:'10 kOhm'}; // 10KOhm
	socket.emit('sset',message,function(data){console.log(data)});
	message = {control:43,value:'10 kOhm'}; // 10KOhm
	socket.emit('sset',message,function(data){console.log(data)});

	let msgdacswitch = leftdacswitch + "," + rightdacswitch;
	message = {control:7,value:msgdacswitch};
	socket.emit('sset',message,function(data){console.log(data)});
	console.log(message);

	message = {control:28,value:leftdacplaysw};
	socket.emit('sset',message,function(data){console.log(data)});
	console.log(message);

	message = {control:31,value:rightdacplaysw};
	socket.emit('sset',message,function(data){console.log(data)});
	console.log(message);

}

function setElement(id,str) {
	var ele = document.getElementById(id);
	if (ele) ele.innerHTML = str
	else console.log("Failed to find ID=" + id);
}

(function () {
	socket.on('systemstats', function(data) {
		socket.send('sset','test');
		if (data.sensors) {
			let sensors = data.sensors;
			let sensdata = "";
			for (let s=0; s < sensors.length; s++) {
				sensdata += sensors[s].label + ": " + sensors[s].value;
				if (s < (sensors.length - 1)) sensdata += " &bull; ";
			}
			setElement("sensors",sensdata);
		}
		if (data.model) setElement("model",data.model);
		if (data.hat.product) {
			let prodtitle = "Vendor: " + data.hat.vendor + ", Product ID: " + data.hat.product_id + ", Version: " + data.hat.product_ver;
			let productID = document.getElementById("product");
			productID.setAttribute("title",prodtitle);
			setElement("product",data.hat.product);
		}
		if (data.cputemp) {
			var cput = "";
			cput += data.cputemp.f + "&deg; F (" + data.cputemp.c + "&deg; C)";
			setElement("cputemp",cput);
		}
		if (data.uptime) {
			var upstr = "";
			if (data.uptime.days > 0) upstr += " " + data.uptime.days + " days";
			var hms = data.uptime.hms.split(":");
			if (parseInt(hms[0]) > 0) upstr += " " + hms[0] + " hrs";
			upstr += " " + hms[1] + " mins";
			setElement("uptime",upstr);
		}
		if (data.loadavg) {
			var la = " 1m:" + data.loadavg.one + " 5m:" + data.loadavg.five + " 15m:" + data.loadavg.fifteen;
			setElement("loadavg", la);
		}
		if (data.mixer) {
			let leftdin = data.mixer.left;	
			let rightdin = data.mixer.right;	
			let commonset = data.mixer.common;
			
			document.getElementById("left-pcmvol").value = leftdin.pcmvol;
			document.getElementById("right-pcmvol").value = rightdin.pcmvol;
			document.getElementById("left-adcvol").value = leftdin.adcvol;
			document.getElementById("right-adcvol").value = rightdin.adcvol;
			document.getElementById("left-lodigvol").value = leftdin.lodigvol;
			document.getElementById("right-lodigvol").value = rightdin.lodigvol;
			document.getElementById("playbackcmsw").value = commonset.playbackcmsw;
			if (leftdin.dacswitch == "off" || leftdin.dacplaysw == "off") document.getElementById("left-audiorx").value = "off";
			else {
				if (leftdin.in1res == "1") document.getElementById("left-audiorx").value = "disc";
				if (leftdin.in2res == "1") document.getElementById("left-audiorx").value = "af";
			}

			if (rightdin.dacswitch == "off" || rightdin.dacplaysw == "off") document.getElementById("right-audiorx").value = "off";
			else {
				if (rightdin.in1res == "1") document.getElementById("right-audiorx").value = "disc";
				if (rightdin.in2res == "1") document.getElementById("right-audiorx").value = "af";
			}
		}
//		console.log(data.mixer);
	});
})();
</script>
